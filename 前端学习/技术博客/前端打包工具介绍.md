## 基本概念

历史上先后出现了一系列构建工具，它们各有优缺点。由于前端工程师很熟悉JavaScript，Node.js又可以胜任所有构建需求，所以大多数构建工具都是用Node.js开发的。

前端技术发展之快，各种可以提高开发效率的新思想和框架层出不穷。但是它们都有一个共同点：源代码无法直接运行，必须通过转换后才可以正常运行。

构建就是做这件事情，将源代码转换成可执行的JavaScript、CSS、HTML代码，包括如下内容。

- 代码转换：将TypeScript编译成JavaScript、将SCSS编译成CSS等。

- 文件优化：压缩JavaScript、CSS、HTML代码，压缩合并图片等。

- 代码分割：提取多个页面的公共代码，提取首屏不需要执行部分的代码让其异步加载。

- 模块合并：在采用模块化的项目里会有很多个模块和文件，需要通过构建功能将模块分类合并成一个文件。

- 自动刷新：监听本地源代码的变化，自动重新构建、刷新浏览器。

- 代码校验：在代码被提交到仓库前需要校验代码是否符合规范，以及单元测试是否通过。

- 自动发布：更新代码后，自动构建出线上发布代码并传输给发布系统。


构建其实是工程化、自动化思想在前端开发中的体现，将一系列流程用代码去实现，让代码自动化地执行这一系列复杂的流程。构建为前端开发注入了更大的活力，解放了我们的生产力。



## 常用打包工具

- gulp：是一个多任务得构建工具，跟jq很像找到一个文件做一系列得操作形成一个任务，整个就是一个任务得集合

- rollup：适用于基础库的打包，基于ES6打包，打包文件小且干净，执行效率更高，vue、react都是基于他打包的
- webpack: 适用于大型的项目，开始就需要通过入口文件开始打包，一次性加载所有的资源。
- vite：实时的打包，开始不会进行打包，所以启动非常快，直接请求所需模块并实时编译



### gulp使用介绍

#### 基本使用

本教程使用的版本是gulp4

##### **安装 gulp 命令行工具**

```shell
npm install --global gulp-cli
```

##### **安装 gulp，作为开发时依赖项**

```shell
npm install --save-dev gulp
```

##### **创建 gulpfile 文件**

利用任何文本编辑器在项目大的根目录下创建一个名为 gulpfile.js 的文件，并在文件中输入以下内容：

```js
function defaultTask(cb) {
  // place code for your default task here
  cb();
}

exports.default = defaultTask
```

##### **运行gulp任务**

只需切换到存放gulpfile.js文件的目录，然后在命令行中执行gulp或gulp taskName命令就行了。

```shell
# 执行默认任务
gulp 
# 执行指定任务
gulp taskName
```

##### **创建任务**

每个 gulp 任务（task）都是一个异步的 JavaScript 函数，此函数是一个可以接收 callback 作为参数的函数，或者是一个返回 stream、promise、event emitter、child process 或 observable 类型值的函数。由于某些平台的限制而不支持异步任务，因此 gulp 还提供了一个漂亮 替代品。

###### **导出任务**

任务（tasks）可以是 **public（公开）** 或 **private（私有）** 类型的。

- **公开任务（Public tasks）** 从 gulpfile 中被导出（export），可以通过 `gulp` 命令直接调用。
- **私有任务（Private tasks）** 被设计为在内部使用，通常作为 `series()` 或 `parallel()` 组合的组成部分。

一个私有（private）类型的任务（task）在外观和行为上和其他任务（task）是一样的，但是不能够被用户直接调用。如需将一个任务（task）注册为公开（public）类型的，只需从 gulpfile 中导出（export）即可。

> 注：*在以前的 gulp 版本中，*`task()` *方法用来将函数注册为任务（task）。虽然这个 API 依旧是可以使用的，但是 导出（export）将会是主要的注册机制，除非遇到 export 不起作用的情况。*

```js
const { series } = require('gulp');

// `clean` 函数并未被导出（export），因此被认为是私有任务（private task）。
// 它仍然可以被用在 `series()` 组合中。
function clean(cb) {
  // body omitted
  cb();
}

// `build` 函数被导出（export）了，因此它是一个公开任务（public task），并且可以被 `gulp` 命令直接调用。
// 它也仍然可以被用在 `series()` 组合中。
function build(cb) {
  // body omitted
  cb();
}

exports.build = build;
exports.default = series(clean, build);
```

###### **组合任务**

Gulp 提供了两个强大的组合方法： `series()` 和 `parallel()`，允许将多个独立的任务组合为一个更大的操作。这两个方法都可以接受任意数目的任务（task）函数或已经组合的操作。`series()` 和 `parallel()` 可以互相嵌套至任意深度。

如果需要让任务（task）按顺序执行，请使用 `series()` 方法。

```js
const { series } = require('gulp');

function transpile(cb) {
  // body omitted
  cb();
}

function bundle(cb) {
  // body omitted
  cb();
}

exports.build = series(transpile, bundle);
```

对于希望以最大并发来运行的任务（tasks），可以使用 `parallel()` 方法将它们组合起来。

```js
const { parallel } = require('gulp');

function javascript(cb) {
  // body omitted
  cb();
}

function css(cb) {
  // body omitted
  cb();
}

exports.build = parallel(javascript, css);
```



#### Gulp常用API

##### **1.task()**

task方法用来定义任务

**提醒**: 这个API不再是推荐的模式了 -，而是推进采用export的方式，参考： [export your tasks](https://www.gulpjs.com.cn/docs/getting-started/creating-tasks)。

将命名函数注册为任务：

```js
const { task } = require('gulp');

function build(cb) {
  // body omitted
  cb();
}

task(build);
```

将匿名函数注册为任务：

```js
const { task } = require('gulp');

task('build', function(cb) {
  // body omitted
  cb();
});
```



##### **2.src()**

src()方法是用来获取流的，但要注意这个流里的内容不是原始的文件流，而是一个虚拟文件对象流(Vinyl files)，这个虚拟文件对象中存储着原始文件的路径、文件名、内容等信息。

```js
src(globs, [options])
```

globs参数是文件匹配模式(类似正则表达式)，用来匹配文件路径(包括文件名)，当然这里也可以直接指定某个具体的文件路径。当有多个匹配模式时，该参数可以为一个数组。



##### **3.dest()**

dest()方法是用来写文件的，主要配合src()使用，可以将src()获取的文件写入到指定的文件目录下。

```js
gulp.dest(path[,options])
```

如：

```js
// 通过src()方法从log文件下获取到该文件夹下面的所有js文件，然后重新写入到dist文件夹下的index中
gulp.task("Copy",function(done){
	gulp.src('log/**/*.js').pipe(gulp.dest('dist/index.js'))
	done()
})
```



##### **4.watch()**

gulp.watch()用来监视文件的变化，当文件发生变化后，我们可以利用它来执行相应的任务，例如文件压缩、[ES6](https://so.csdn.net/so/search?q=ES6&spm=1001.2101.3001.7020)代码转换等等

```js
watch(globs, [options], [task])
```

- glob 为要监视的文件匹配模式，规则和用法与gulp.src()方法中的glob相同。
- tasks 为文件变化后要执行的任务

```js
// watch会一直监听log文件下所有的js文件，当某一个js文件发生变化之后，会立马执行任务一和任务二，当我们改变log下面的任意一个js文件之后，watch会立马做对应的反应，执行对应任务。
gulp.watch('log/*.js', gulp.series('one','two',function(cb){
    cb()
}));
```



#### Gulp常用插件

##### **自动加载插件(gulp-load-plugins)**

可以一次性包括package.json 里面的所有的 gulp 依赖包，无需在 gulpfile.js 使用require 关键字一个一个的把依赖包导入进去。可以实现按需引入，节省项目空间，利于优化。

```shell
 npm install --save-dev gulp-load-plugins
```

给定一个`package.json` 文件，该文件具有以下依赖关系：

```json
{
    "dependencies": {
        "gulp-jshint": "*",
        "gulp-concat": "*"
    }
}
```

之前你在Gulpfile.js中使用插件的方式：

```javascript
const gulp = require('gulp');
const gulpJshint = require('gulp-jshint');
const gulpConcat = require('gulp-concat');
```

现在到您的Gulpfile.js：

```javascript
const gulp = require('gulp');
const plugins = require('gulp-load-plugins')();
const gulpJshint = plugins.jshint; // 其实可以不用定义变量，直接在需要使用这个插件的地方 plugins.jshint() 就可以了
const gulpConcat = plugins.concat;  //其实可以不用定义变量，直接在需要使用这个插件的地方 plugins.concat() 就可以了
```

有了这个插件您不必在gulfile.js中手动引入每个gulp插件了。

##### **重命名（ gulp-rename）**

```shell
npm install --save-dev gulp-rename
```

用于给文件重新命名的，比如对js文件压缩后，改后缀名为`.min.js`

```js
var gulp = require('gulp'),
rename = require('gulp-rename'),
gulp.task('rename', function () {
  	gulp.src('log/test.js')
    .pipe(rename('test.min.js')) //会将test.js重命名为test.min.js
    .pipe(gulp.dest('js'))})
```



##### **js文件压缩（gulp-uglify）**

```shell
npm install --save-dev gulp-uglify
```

对js文件进行压缩

```js
var gulp = require('gulp'),
uglify = require("gulp-uglify");
		gulp.task('uglify', function () {gulp.src('log/index.js')
    .pipe(uglify())  //压缩
    .pipe(gulp.dest('js'))})

```



##### **css文件压缩（gulp-minify-css）**

```shell
npm install --save-dev gulp-minify-css
```

对css文件进行压缩

```js
var gulp = require('gulp'),
minifyCss = require("gulp-minify-css");
gulp.task('minify-css', function () {
    gulp.src('css/*.css') // 要压缩的css文件
    .pipe(minifyCss()) //压缩css
    .pipe(gulp.dest('dist/css'));
});
```



##### **html文件压缩（gulp-minify-html）**

```shell
npm install --save-dev gulp-minify-html
```

对html文件进行压缩

```js
var gulp = require('gulp'),
    minifyHtml = require("gulp-minify-html");
gulp.task('minify-html', function () {
    gulp.src('html/*.html') // 要压缩的html文件
    .pipe(minifyHtml()) //压缩
    .pipe(gulp.dest('dist/html'));
});
```



##### **less的编译（gulp-less）**

```shell
npm install --save-dev gulp-less
```

将less文件编译为css文件

```js
var gulp = require('gulp'),
    less = require("gulp-less");
gulp.task('compile-less', function () {
    gulp.src('less/*.less')
    .pipe(less())
    .pipe(gulp.dest('dist/css'));
});
```



##### **图片压缩（gulp-imagemin）**

```shell
npm install --save-dev gulp-imagemin
```

对图片文件进行压缩

```js
var gulp = require('gulp');
var imagemin = require('gulp-imagemin');
var pngquant = require('imagemin-pngquant'); //png图片压缩插件
gulp.task('default', function () {
    return gulp.src('src/images/*')
        .pipe(imagemin({
            progressive: true,
            use: [pngquant()] //使用pngquant来压缩png图片
        }))
        .pipe(gulp.dest('dist'));
});
```



##### **ES6 转换成 ES5 （gulp-babel babel-core）**

安装babel& ES6 转换成 ES5 插件

```shell
npm install --save-dev gulp-babel babel-core
npm install --save-dev babel-preset-es2015
```

将ES6代码转换为ES5代码

```js
var gulp = require('gulp'),
babel = require('gulp-babel');
gulp.task('es6',  () => {
  return gulp.src('app/*.js')
    .pipe(babel())
    .pipe(gulp.dest('dist'));
});
```

##### 自动化开发服务器（gulp-webserver）

```shell
npm install --save-dev gulp-webserver
```

配置开发服务器

```js
const serverHandler = () => {
  return gulp
    .src('./dist') // 找到你要开启的文件夹, 打包后生成的文件夹
    .pipe(webserver({ // 配置启动服务器
      host: 'localhost', // 域名
      port: '9888', // 端口号
      open: './views/index.html', // 默认打开哪一个 html 文件, 你网站默认的首页
      livereload: true, // 自动刷新页面, 当你的代码发生任何修改以后, 会自动刷新页面
      // 开始进行代理配置
      proxies: [
        {
          // 代理标识符
          source: '/dt',
          // 跨域的请求地址
          target: 'http://www.example.com/path'
        }
      ]
    }))
}
```




#### 使用示例





## 参考

- https://juejin.cn/post/7103150432410681381